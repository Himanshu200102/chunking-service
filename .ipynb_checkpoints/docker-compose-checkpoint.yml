version: "3.9"

services:
  mongo:
    image: mongo:7
    container_name: drm-mongo
    restart: unless-stopped
    ports: ["27017:27017"]
    volumes:
      - mongo_data:/data/db

  opensearch:
    image: opensearchproject/opensearch:2.13.0
    container_name: drm-opensearch
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
      - plugins.security.disabled=true
    ulimits:
      memlock: { soft: -1, hard: -1 }
    ports: ["9200:9200", "9600:9600"]
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    environment: 
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=Quantamind@123 
      - discovery.type=single-node

  dashboards:  # optional, nice for inspection
    image: opensearchproject/opensearch-dashboards:2.13.0
    container_name: drm-dashboards
    depends_on: [opensearch]
    environment:
      - OPENSEARCH_HOSTS=["http://opensearch:9200"]
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
    ports: ["5601:5601"]

  api:
    build: .
    container_name: drm-api
    depends_on: [mongo, opensearch]
    env_file: [".env"]
    working_dir: /app
    volumes:
      - ./uploads:/app/uploads
      - lancedb_data:/data/lancedb
    ports: ["8000:8000"]
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

volumes:
  mongo_data:
  opensearch_data:
  lancedb_data:
